---
title: "CreativeAssignmentThree"
author: "Whytne Stevens"
date: "9/24/2020"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_depth: 3
    toc_float: true
---
# Intro/Set Up

For this creative assignment, I was interested in looking at datasets from Paris, France. First I loaded relevant r libraries as well as other r libraries that might be useful to me later on and pulled a world map using the libraries loaded below.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries, results = "hide", message = FALSE, warning = FALSE}
library(sf)
library(tidyverse)
library(ggthemes)
library(ggspatial)
library(units)
library(nngeo)
library(wesanderson)
library(ggplot2)
library(rnaturalearth)
library(cartogram)
library(rgeos)
library(packcircles)
library(viridis)
```


With the knowledge of French that I do have, I was able to decipher what many of the datasets were exploring. I ended up choosing the following for this assignment:

- Logements sociaux financés à Paris/ Public Housing in Paris 

- Espaces verts et assimilés/ Paris Green Spaces 

- Arrondissements/Paris Neighborhoods

- Etablissements scolaires – Collèges/ Middle Schools in Paris

Next, I loaded the data I found on opendata.paris.fr:

```{r}
neighborhoods <- st_read("https://opendata.paris.fr/explore/dataset/arrondissements/download/?format=kml&timezone=America/Chicago&lang=fr", 
                  quiet = TRUE) 

publichousing <- st_read("https://opendata.paris.fr/explore/dataset/logements-sociaux-finances-a-paris/download/?format=kml&timezone=America/Chicago&lang=fr", 
                 quiet = TRUE)

middleschools <- st_read("https://opendata.paris.fr/explore/dataset/etablissements-scolaires-colleges/download/?format=kml&timezone=America/Chicago&lang=fr", 
                   quiet = TRUE) 

greenspaces <- st_read("https://opendata.paris.fr/explore/dataset/espaces_verts/download/?format=kml&timezone=America/Chicago&lang=fr", 
                 quiet = TRUE) 
```


After loading the data, I then transformed it using the NTF France III degrees coordinate system

```{r}
NTF_France_III_degrees <-"+proj=lcc +lat_1=44.1 +lat_0=44.1 +lon_0=2.337229166666667 +k_0=0.999877499 +x_0=600000 +y_0=3200000 +a=6378249.2 +b=6356514.999904194 +units=m +no_defs"

neighborhoods <- neighborhoods %>%
  st_transform(NTF_France_III_degrees)

publichousing <- publichousing %>%
  st_transform(NTF_France_III_degrees)

middleschools <- middleschools %>%
  st_transform(NTF_France_III_degrees)

greenspaces <- greenspaces %>%
  st_transform(NTF_France_III_degrees)
```

And also selected a color palette to use for some of the maps using the wesanderson package:

```{r}
pal <- wes_palette("Royal1", 100, type = "continuous")
```


Below is the map I produced visualizing all of my datasets; here is the key:
- Logements sociaux financés à Paris/ Public Housing in Paris are represented by the blue dots

- Espaces verts et assimilés/ Paris Green Spaces are in green

- Arrondissements/Paris Neighborhoods are in ivory

- Etablissements scolaires – Collèges/ Middle Schools in Paris are represented by the red-orange dots


```{r, fig.height=11}
ggplot(neighborhoods) +
  geom_sf(fill = "ivory", color = "ivory4") +
  geom_sf(data= greenspaces, fill = "darkseagreen", color = "darkseagreen") +
  geom_sf(data = middleschools, color = "tomato",size = 2) +
  geom_sf(data = publichousing, color = "steelblue", size = 1) +
    scale_color_manual(values = c("ivory", "darkseagreen", "tomato", "steelblue"),
          name = "Map Legend", 
          labels = c("Neighborhoods",
                     "Greenspaces",
                     "Middle Schools",
                     "Public Housing Buildings/Units"))+
  theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray")) +
  annotation_scale()
```

# Distances Between Points 

## The number and proportion of Middle Schools in Paris with a specified distance of a Public Housing Building/Unit in Paris . 

I was first interested in calculating the number of middle schools within a certain distance of a public housing building/unit. At first I wanted the distance to represent the average distance walked in 30 min but after doing that the buffer became too big, so I set my buffer to 100 meters


```{r, fig.height=7}
publichousing_buffer <- st_buffer(publichousing, dist = 100) %>%
  st_union()

ggplot(publichousing_buffer) +
  geom_sf() +
    geom_sf(data = publichousing_buffer, 
          fill = "ivory") +
    theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```


I then plotted the middle schools, represented by the red-orange dots

```{r, fig.height=7}
middleschools_publichousing <- middleschools[publichousing_buffer,]
  
ggplot(publichousing_buffer) +
  geom_sf() +
      geom_sf(data = publichousing_buffer, 
          fill = "ivory")+
  geom_sf(data = middleschools_publichousing, 
          color = "tomato2", 
          size = 2) +
   theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```


I then ran some codes to analyze my dataset and provide me with a concrete number for how many middle schools are located within 100 meters of a public housing building/unit in Paris:

```{r}
middleschools <- middleschools %>%
  st_join(middleschools_publichousing) %>%
  mutate(by_publichousing = !is.na(Name.y))
```



```{r}
n_publichousing_middleschools <- sum(middleschools$by_publichousing)

n_publichousing_middleschools
```



```{r}
n_middleschools <- length(middleschools$by_publichousing)

pct_publichousing_middleschools <- n_publichousing_middleschools / n_middleschools

pct_publichousing_middleschools
```

Based on this analysis, there are about 263, or 63% of middle schools are located within 100 meters of a public housing building/unit in Paris. I decided to map out my results here as well:


```{r, fig.height=7}
left_side  <- st_bbox(greenspaces)$xmin
top_side <- st_bbox(greenspaces)$ymax

ggplot(neighborhoods) +
  geom_sf(fill = "ivory", color = "ivory4") +
  geom_sf(data = middleschools, size = 3,
          aes(color = by_publichousing)) +
  scale_color_manual(values = c("tomato4", "tomato2"),
          name = "Paris Middle Schools\nby distance to a Public Housing Building/Unit", 
          labels = c("No Public Housing Units within 30 m",
                     "Public Housing Unit within 30 m")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  annotate(geom = "text", x = left_side, 
           y = top_side, 
           label = paste("Of the ", 
                         prettyNum(n_middleschools, big.mark = ","),
                         " middle schools in Paris\n", 
                         prettyNum(n_publichousing_middleschools, big.mark = ","),
                         " (", 
                         prettyNum(100*pct_publichousing_middleschools, digits = 0),
                         "%) are within 100 meters \nof a Public Housing Building/Unit.",
                         sep = ""),
           hjust = 0.10, vjust = 1, size = 4) +
  theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```



## The average (Euclidean) distance between Middle Schools in Paris and their nearest respective Public Housing in Paris.

Next, I was interested in calculating the average distance between middle schools and public housing buildings/units in Paris. At first I wanted the distance to represent the average distance walked in 30 min but after doing that the buffer became too big, so I set my buffer to 100 meters. I ran some codes to and provide me with a concrete number for this question as well:


```{r}
middleschools <- middleschools %>%
  mutate(publichousing_dist = st_nn(middleschools, publichousing, 
                           returnDist = TRUE)$dist) %>%
  mutate(publichousing_dist = as.numeric(publichousing_dist))
```

```{r}
avg_publichousing_dist <- mean(middleschools$publichousing_dist)

avg_publichousing_dist
```

The result came to be 94.64589 meters, which is the average distance between middle schools and public housing buildings/units in Paris. I mapped this as well:


```{r, fig.height=7}
right_side <- st_bbox(greenspaces)$xmax
left_side  <- st_bbox(greenspaces)$xmin
top_side <- st_bbox(greenspaces)$ymax
bottom_side <- st_bbox(greenspaces)$ymin


ggplot(neighborhoods) +
  geom_sf(fill = "ivory", color = "ivory4") +
  geom_sf(data = middleschools, size = 3,
          aes(color = publichousing_dist)) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
  scale_color_gradientn(name =  "Paris middle schools\nby distance to a Public Housing Building/Unit",
                        colors = pal) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  annotate(geom = "text", x = left_side + 2000, 
           y = top_side - 1500, 
           label = paste("On average, a Paris middle school\nis ", 
                         prettyNum(avg_publichousing_dist, digits = 3),
                         " meters from a \nPublic Housing Building/Unit.",
                         sep = ""),
           hjust = 0.20, vjust = 0.5, size = 4) +
  theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```







# Number/Proportion of Points in a Polygon
The following maps visualize 1) the number and proportion of public housing buildings/units and middle schools in Paris neighborhoods and 2) the number and proportion of Paris neighborhoods containing public housing buildings/units and middle schools:

## The number and proportion of Public Housing in Paris within Paris Neighborhoods. 
```{r}
neighborhoodsmap1 <- neighborhoods %>%
  mutate(num_publichousing = lengths(st_covers(neighborhoods, publichousing)))
```

```{r, fig.height=7}
ggplot(neighborhoodsmap1) +
  geom_sf(color = NA, 
          aes(fill = num_publichousing)) +
  scale_fill_gradientn(name = "Paris neighborhoods\nby number of Public Housing Buildings/Units",
    breaks = seq(0, 1000, by = 50),
    labels = formatC(seq(0, 1000, by = 50), 
                     big.mark = ",", format = "f", digits = 0),
    colors = pal) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```



## The number and proportion of Middle Schools in Paris within Paris Neighborhoods. 
```{r}
neighborhoodsmap2 <- neighborhoods %>%
  mutate(num_middleschools = lengths(st_covers(neighborhoods, middleschools)))
```

```{r, fig.height=7}
ggplot(neighborhoodsmap2) +
  geom_sf(color = NA, 
          aes(fill = num_middleschools)) +
  scale_fill_gradientn(name = "Paris neighborhoods\nby number of Middle Schools",
    breaks = seq(0, 50, by = 10),
    labels = formatC(seq(0, 50, by = 10), 
                     big.mark = ",", format = "f", digits = 0),
    colors = pal) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```




## The number and proportion of Paris Neighborhoods containing Public Housing in Paris .

```{r}
neighborhoodsmap3 <- neighborhoods %>%
  mutate(num_publichousing = lengths(st_covers(neighborhoods, publichousing))) %>%
  mutate(area = set_units(st_area(neighborhoods), km^2)) %>%
  mutate(publichousing_dens = as.numeric(num_publichousing / area))
```

```{r, fig.height=7}
ggplot(neighborhoodsmap3) +
  geom_sf(color = NA, 
          aes(fill = publichousing_dens)) +
    scale_fill_gradientn(name = 
                           "Paris neighborhoods\nby Public Housing Building/Unit\n density",
                       breaks = breaks <- seq(0, 90, by = 15),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "Public Housing \nBuildings/Units per square km"),
                       
    colors = pal) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
 theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```




 
## The number and proportion of Paris Neighborhoods containing Middle Schools in Paris

```{r}
neighborhoodsmap4 <- neighborhoods %>%
  mutate(num_middleschools = lengths(st_covers(neighborhoods, middleschools))) %>%
  mutate(area = set_units(st_area(neighborhoods), km^2)) %>%
  mutate(middleschools_dens = as.numeric(num_middleschools / area))
```


```{r, fig.height=7}
ggplot(neighborhoodsmap4) +
  geom_sf(color = NA, 
          aes(fill = middleschools_dens)) +
    scale_fill_gradientn(name = 
                           "Paris neighborhoods\nby density of middle schools",
                       breaks = breaks <- seq(0, 10, by = 1),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "middle schools per square km"),
                       colors = pal) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.position = "right",
    legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```
## The number and proportion of Public Housing Buildings/Units in Paris within Paris Green Spaces. 

I was curious to see how many public housing buildings/units in Paris were within a green space in Paris, and interestingly the number was very low, as demonstrated in the map below:

```{r}
greenspacesmap <- greenspaces %>%
  mutate(num_publichousing = lengths(st_covers(greenspaces, publichousing)))
```

```{r, fig.height=7}
pal <- wes_palette("Royal1", 100, type = "continuous")

ggplot(greenspacesmap) +
  geom_sf(color = NA, 
          aes(fill = num_publichousing)) +
  scale_fill_gradientn(name = "Paris greenspaces\nby number of \nPublic Housing Buildings/Units",
    breaks = seq(0, 10, by = 1),
    labels = formatC(seq(0, 10, by = 1), 
                     big.mark = ",", format = "f", digits = 0),
    colors = pal) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```





## The number and proportion of Paris Green Spaces that overlap with Paris Neighborhoods.

Lastly, I decided to calculate the number and proportion of green spaces that overlap with Paris neighborhoods and map that as well:

```{r}
neighborhoods <- neighborhoods %>%
  mutate(num_greenspaces = lengths(st_overlaps(neighborhoods, greenspaces))) %>%
  mutate(has_greenspaces = num_greenspaces > 0)
```

```{r}
n_greenspaces_neighborhoods <- sum(neighborhoods$has_greenspaces)

n_greenspaces_neighborhoods
```

```{r, fig.height=7}
left_side  <- st_bbox(greenspaces)$xmin
top_side <- st_bbox(greenspaces)$ymax

ggplot(greenspaces) +
  geom_sf(fill = "ivory", color = "ivory4") +
  geom_sf(data = neighborhoods,
          aes(fill = has_greenspaces)) +
  scale_fill_manual(values = c("darkseagreen2", "darkseagreen4"),
          name = "Paris Neighborhoods\nby presence of a green space", 
          labels = c("Neighborhood without\nan overlapping green space",
                     "Neighborhood with an\noverlapping green space")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  annotate(geom = "text", x = left_side, 
           y = top_side - 1000, 
           label = paste(n_greenspaces_neighborhoods ,
                         "of Paris's", 
                         length(neighborhoods$Name),
                         "neighborhoods contain\nor overlap with", 
                         "a green space."),
           hjust = 0.05, vjust = 0, size = 4) +
  theme_map() +
  theme(panel.background = element_rect(fill = "seashell2"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```




# Conclusion/Final Thoughts

Provided with more time, I would go back and do a deeper analysis of each neighborhood to add more context to what has been visualized here and therefore to further understand the results I got from making these maps.