---
title: "CreativeAssignmentFour"
author: "Whytne Stevens"
date: "10/3/2020"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_depth: 3
    toc_float: true
---
# Intro/Set Up

For this creative assignment, I picked a dataset plotting all the farmer's markets in the Washington, D.C. city limits. First I loaded relevant r libraries as well as other r libraries that might be useful to me later on. I also loaded the dataset from the DC Open Data Portal. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries, results = "hide", message = FALSE, warning = FALSE}
library(osmdata)
library(opentripplanner)
library(tidyverse)
library(sf)
library(ggthemes)
library(ggspatial)
library(sp)
library(stringr)
library(rgeos)
library(tidygeocoder)
```


```{r load farmers markets}
dcfarmersmarkets<- st_read(
  "https://opendata.arcgis.com/datasets/f2e1c2ef9eb44f2899f4a310a80ecec9_2.kml")
```

Next, I defined my coordinate system. Since Washington, D.C.is between Virginia and Maryland, I had to decide which state's coordinate system would be best to use. I settled on the __ coordinate system

```{r}
MDstateplane <- "+proj=lcc +lat_1=38.3 +lat_2=39.45 +lat_0=37.66666666666666 +lon_0=-77 +x_0=400000 +y_0=0 +ellps=GRS80 +units=m +no_defs"

dc_street_features <- opq(bbox = 'Washington DC USA') %>%
  add_osm_feature(key = 'highway') %>%
  osmdata_sf()

dc_streets <- dc_street_features$osm_lines %>%
  st_transform(crs = MDstateplane)
```



Once defining the coordinate system, I loaded a map with Washington D.C.'s street network and increased the size of the map to better see some of the street grid

```{r, fig.height=33}
ggplot(dc_streets) +
  geom_sf() +
  theme_map()
```

Then I connected to Open Trip Planner

```{r}
path_otp <- otp_dl_jar("OTP")
```


```{r, message = FALSE, warning = FALSE, echo = FALSE}
path_data <- file.path(getwd(), "OTP")
path_otp <- paste(path_data, "otp.jar",sep = "/")

otp_build_graph(otp = path_otp, dir = path_data, memory = 1024) 
```


```{r}
otp_setup(otp = path_otp, dir = path_data, memory =1024)

#  Connect to opentripplanner

otpcon <- otp_connect()
```

# Creating Isochrones
## Defining and Mapping Isochrones

After the initial set up, I defined the isochrones for the farmer's markets for the modes of transit I chose which were driving, walking, and biking


```{r}
iso_5min_walk <- 
  otp_isochrone(otpcon = otpcon, fromPlace = dcfarmersmarkets, 
                mode = "WALK", cutoffSec = 300) %>%
  st_transform(crs = MDstateplane) %>%
  mutate(mode = "walk")

iso_5min_drive <- 
  otp_isochrone(otpcon = otpcon, fromPlace = dcfarmersmarkets, 
                mode = "CAR", cutoffSec = 300) %>%
  st_transform(crs = MDstateplane) %>%
  mutate(mode = "drive")

iso_5min_bike <- 
  otp_isochrone(otpcon = otpcon, fromPlace = dcfarmersmarkets, 
                mode = "BICYCLE", cutoffSec = 300) %>%
  st_transform(crs = MDstateplane) %>%
  mutate(mode = "bike")

iso_all_modes <- rbind(iso_5min_drive, iso_5min_walk, iso_5min_bike)

otp_stop()
```


And here is a map of the isochrones for each of the farmer's markets

```{r, fig.height=11}
right_side <- st_bbox(iso_all_modes)$xmax
left_side  <- st_bbox(iso_all_modes)$xmin
top_side <- st_bbox(iso_all_modes)$ymax
bottom_side <- st_bbox(iso_all_modes)$ymin

ggplot(iso_all_modes) +
  annotation_map_tile(zoomin = 0, type = "stamenbw", progress = "none")  +
  geom_sf(aes(fill = mode), alpha = 0.5) +
  geom_sf(data = dcfarmersmarkets) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
  scale_fill_viridis_d(name = "Area that is reachable within 5 minutes",
                     labels = c("By foot", "By bike", "By car")) +
  theme_map() +
  labs(caption = "Basemap Copyright OpenStreetMap contributors")
```

## Other Ways of Visualizing Results
From the mapping I did above, I then made some scatter and violin plots to compare each mode of transit to one another


```{r, fig.height=7}
iso_areas <- iso_all_modes %>%
  mutate(area = st_area(iso_all_modes)) %>%
  st_set_geometry(NULL) %>%
  pivot_wider(names_from = mode, values_from = area) 

ggplot(iso_areas, 
       aes(x = as.numeric(walk), y = as.numeric(drive))) +
  geom_point() +
  scale_x_continuous(name = 
            "Area within a five-minute walking distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(10000, 130000, by = 20000),
            labels = breaks / 1000000) +
  scale_y_continuous(name = 
            "Area within a five-minute driving distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(0, 1400000, by = 100000),
            labels = breaks / 1000000) +
 theme_solarized()
```

```{r, fig.height=7}
ggplot(iso_areas, 
       aes(x = as.numeric(walk), y = as.numeric(drive))) +
  geom_violin() +
  scale_x_continuous(name = 
            "Area within a five-minute walking distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(10000, 130000, by = 20000),
            labels = breaks / 1000000) +
  scale_y_continuous(name = 
            "Area within a five-minute driving distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(0, 1400000, by = 100000),
            labels = breaks / 1000000) +
  theme_solarized()
```


```{r, fig.height=7}
ggplot(iso_areas, 
       aes(x = as.numeric(walk), y = as.numeric(bike))) +
  geom_point() +
  scale_x_continuous(name = 
            "Area within a five-minute walking distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(10000, 180000, by = 20000),
            labels = breaks / 1000000) +
  scale_y_continuous(name = 
            "Area within a five-minute biking distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(0, 1800000, by = 100000),
            labels = breaks / 1000000) +
 theme_solarized()
```

```{r, fig.height=7}
ggplot(iso_areas, 
       aes(x = as.numeric(walk), y = as.numeric(bike))) +
  geom_violin() +
  scale_x_continuous(name = 
            "Area within a five-minute walking distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(10000, 200000, by = 20000),
            labels = breaks / 1000000) +
  scale_y_continuous(name = 
            "Area within a five-minute biking distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(0, 1400000, by = 100000),
            labels = breaks / 1000000) +
  theme_solarized()
```


```{r, fig.height=7}
ggplot(iso_areas, 
       aes(x = as.numeric(drive), y = as.numeric(bike))) +
  geom_point() +
  scale_x_continuous(name = 
            "Area within a five-minute driving distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(10000, 2000000, by = 200000),
            labels = breaks / 1000000) +
  scale_y_continuous(name = 
            "Area within a five-minute biking distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(0, 1400000, by = 100000),
            labels = breaks / 1000000) +
 theme_solarized() 
```


```{r, fig.height=7}
ggplot(iso_areas, 
       aes(x = as.numeric(drive), y = as.numeric(bike))) +
  geom_violin() +
  scale_x_continuous(name = 
            "Area within a five-minute driving distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(10000, 2080000, by = 200000),
            labels = breaks / 1000000) +
  scale_y_continuous(name = 
            "Area within a five-minute biking distance\nof a farmer's market\n(square km)",
            breaks = breaks <- seq(0, 1400000, by = 100000),
            labels = breaks / 1000000) +
  theme_solarized()
```


Based on these plots, it seems that the area within a five minute walking, driving, or biking distance from most of the farmer's markets is between 0.5 and 0.8 square km


# Looking at Isochrones for Select Farmer's Market Locations

## Selecting Famrer's Markets Locations

I futher wanted to look at these isochrones on a closer scale, so I picked four of the farmer's markets based on some of the museums and places in Washington D.C. I'm familiar with - the Library of Congress, the Smithsonian, Howard University, and DuPont Circle:



```{r}
addresslist = c("225 7th St SE, Washington, DC", 
                 "1500 20th St NW, Washington, DC",
                 "901 23rd St NW, Washington, DC",
                 "1300 Pennsylvania Ave NW, Washington, DC")
points <- geo(address = addresslist, mode = "batch") 
head(points)
```


As with the initial isochrone map I made, I connected to Open Trip Planner Again

```{r}
otp_setup(otp = path_otp, dir = path_data, memory =1024)

#  Connect to opentripplanner

otpcon <- otp_connect()
```


```{r}
points <- st_as_sf(x = points,                         
           coords = c("long", "lat"),
           crs = 4326)
```

```{r}
multiple_points_10min_walk <- 
  otp_isochrone(otpcon = otpcon, fromPlace = points, 
                mode = "WALK", cutoffSec = 600)
```




And mapped the isochrone for a 10 min walk only to these farmer's market locations

```{r, fig.height=7}
ggplot(multiple_points_10min_walk) +
  annotation_map_tile(zoomin = 0, type = "stamenbw", progress = "none") +
  geom_sf(fill ="orange", alpha=0.2) +
  theme_map()
```




I also mapped the transit score for each of these farmer's markets, using a dataset with all of the locations of DC Metro train stations

```{r}
metrostops <- st_read("https://opendata.arcgis.com/datasets/54018b7f06b943f2af278bbe415df1de_52.kml",
                     quiet=TRUE)
```



```{r}
multiple_points_10min_walk <- multiple_points_10min_walk %>%
  mutate(transit_score = lengths(st_covers(geometry, metrostops)))
```





Here is the resulting map:


```{r, fig.height=7}
ggplot(multiple_points_10min_walk) +
  annotation_map_tile(zoomin = 0, type = "stamenbw", progress = "none") +
  geom_sf(aes(fill=transit_score), alpha=.5) +
  theme_map()
```


It seems that the Capital Harvest on the Plaza farmer's market, located at 1300 Pennsylvania Ave NW, has the best transit score of all the markets I chose to map, while the other 3 locations have a similar transit score




# Experimenting with Geocoding

Last but not least, I wanted to try creating some of the visualizations in the Geocoding tutorial. 

## Set Up

First I loaded a dataset of Washington D.C.neighborhoods, as defined by the planning authority there


```{r}
dchoods <- st_read("https://opendata.arcgis.com/datasets/f6c703ebe2534fc3800609a07bad8f5b_17.kml", 
                  quiet = TRUE) 

dchoods1 <- as(dchoods, "Spatial")
```



```{r, fig.height=7}
plot(dchoods1)
```




Then created the 1000 dot grid

```{r}
points1 <-spsample(dchoods1, n=1000, type='regular')
```



```{r, fig.height=7}
plot(points1)
```


```{r}
points1 <- st_as_sf(x = points1,                         
           coords = coords,
           crs = 4326)
```



And then plotted how many transots stops are within a 10 minute walk

```{r}
iso_10min_walk1 <- 
  otp_isochrone(otpcon = otpcon, fromPlace = points1, 
                mode = "WALK", cutoffSec = 600)
```



```{r}
otp_stop()
```




```{r}
iso_10min_walk1 <- iso_10min_walk1 %>%
  mutate(transit_score = lengths(st_covers(geometry, metrostops)))
```


```{r}
out <- data.frame(str_split_fixed(iso_10min_walk1$fromPlace, ",", 2))

out <- st_as_sf(x = out,                         
           coords = c("X2", "X1"),
           crs = 4326)
  
out$transit_score <- iso_10min_walk1$transit_score
```

## Initial Results

```{r, fig.height=7}
ggplot(dchoods) +
  geom_sf(fill="gray32", color="gray60")+
  geom_sf(data = out, aes(color=transit_score))+
  scale_color_gradientn(name="Number of Metro stops\nwithin a 10 min walk", colors=c("orangered", "yellow", "lawngreen"))+
  theme_map()+
  theme(legend.position = c(.7,0),
        plot.title = element_text(hjust = 0.5))+
  labs(title = "Transit Acessibility Map")
```




As you can see from the map above, for large parts of the city there are little to no metro stops within a 10 min walk for most people, with the exception of the city center, where many of the jobs and actvity are located. Surprised by this I then repeated this same process but for a 20 min walk instead

```{r}
otp_setup(otp = path_otp, dir = path_data, memory =1024)

#  Connect to opentripplanner

otpcon <- otp_connect()
```

```{r}
iso_20min_walk <- 
  otp_isochrone(otpcon = otpcon, fromPlace = points1, 
                mode = "WALK", cutoffSec = 1200)
```



```{r}
otp_stop()
```




```{r}
iso_20min_walk <- iso_20min_walk %>%
  mutate(transit_score2 = lengths(st_covers(geometry, metrostops)))
```


```{r}
out <- data.frame(str_split_fixed(iso_20min_walk$fromPlace, ",", 2))

out <- st_as_sf(x = out,                         
           coords = c("X2", "X1"),
           crs = 4326)
  
out$transit_score2 <- iso_20min_walk$transit_score2
```



```{r, fig.height=7}
ggplot(dchoods) +
  geom_sf(fill="gray32", color="gray60")+
  geom_sf(data = out, aes(color=transit_score2))+
  scale_color_gradientn(name="Number of Metro stops\nwithin a 20 min walk", colors=c("orangered", "yellow", "lawngreen"))+
  theme_map()+
  theme(legend.position = c(.7,0),
        plot.title = element_text(hjust = 0.5))+
  labs(title = "Transit Acessibility Map")
```





The results for this map are better in terms of transit accessibility. However, it's still a concern that most people would have to walk 20 min to access a Metro stop therefore showing that parts of the DC Metro tranist system are unaccesible to those outside of the city center























